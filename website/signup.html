<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>GB&M â€“ Sign up / Log in</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="styles/default.css">
  <link rel="stylesheet" href="styles/signup.css">
</head>
<body>
<header>
  <div class="header-wrap">
    <a class="brand" href="index.html">
      <div class="logo">GB</div>
      <div class="title">GitBooks & MORE</div>
    </a>
    <div></div>
    <nav>
      <a href="marketplace.html">Marketplace</a>
      <a href="new-listing.html">Sell an Item</a>
    </nav>
  </div>
</header>

<main class="wrap">
  <div class="card">
    <div class="tabs">
      <button id="tabSignup" class="active">Sign Up</button>
      <button id="tabLogin">Log In</button>
    </div>

    <section id="signupPanel">
      <form id="signupForm" novalidate>
        <input id="suFirstName" type="text" placeholder="First Name" required />
        <input id="suLastName" type="text" placeholder="Last Name" required />
        <input id="suEmail" type="email" placeholder="UNCC email" required />
        <input id="suPhone" type="tel" placeholder="Phone (optional)" />
        <input id="suPass" type="password" placeholder="Password (8+ chars)" minlength="8" required />
        <input id="suPass2" type="password" placeholder="Confirm password" minlength="8" required />
        <button class="btn" type="submit">Create account</button>
        <div id="signupMsg" class="msg"></div>
      </form>
    </section>

    <section id="loginPanel" style="display:none">
      <form id="loginForm" novalidate>
        <input id="liEmail" type="email" placeholder="Email" required />
        <input id="liPass" type="password" placeholder="Password" required />
        <button class="btn" type="submit">Log in</button>
        <div id="loginMsg" class="msg"></div>
      </form>
    </section>
  </div>
</main>

<!-- Load API ONCE at the end of body -->
<script src="javascript/api.js"></script>
<script>
  // Tab switching
  const tabSignup = document.getElementById('tabSignup');
  const tabLogin = document.getElementById('tabLogin');
  const signupPanel = document.getElementById('signupPanel');
  const loginPanel = document.getElementById('loginPanel');

  tabSignup.onclick = () => {
    signupPanel.style.display = 'block';
    loginPanel.style.display = 'none';
    tabSignup.classList.add('active');
    tabLogin.classList.remove('active');
  };

  tabLogin.onclick = () => {
    signupPanel.style.display = 'none';
    loginPanel.style.display = 'block';
    tabLogin.classList.add('active');
    tabSignup.classList.remove('active');
  };

  // Helper function to display user-friendly error messages
  function getErrorMessage(error) {
    const message = error.message || 'An error occurred';
    
    // Clean up the message
    let displayMessage = message;
    
    // Remove redundant "Validation error:" prefix if the message already indicates validation
    if (displayMessage.includes('Validation error:') && displayMessage.includes('is required')) {
      displayMessage = displayMessage.replace('Validation error: ', '');
    }
    
    // Common error patterns and their user-friendly versions
    const errorMappings = {
      'Password must be between 8 and 64 characters': 'Password must be at least 8 characters long',
      'Email is not valid': 'Please enter a valid email address',
      'Email already in use': 'This email is already registered. Try logging in instead.',
      'Invalid credentials': 'Incorrect email or password. Please try again.',
      'Too many requests': 'Too many attempts. Please wait a minute and try again.',
      'Cannot connect to server': 'Unable to connect to the server. Please make sure the backend is running.',
    };
    
    // Check if the error message matches any known patterns
    for (const [pattern, friendlyMessage] of Object.entries(errorMappings)) {
      if (displayMessage.includes(pattern)) {
        return friendlyMessage;
      }
    }
    
    return displayMessage;
  }

  // Email validation
  const emailRx = /@(uncc\.edu|charlotte\.edu|student\.edu)$/i;

  // Signup Form
  document.getElementById('signupForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const firstName = document.getElementById('suFirstName').value.trim();
    const lastName = document.getElementById('suLastName').value.trim();
    const email = document.getElementById('suEmail').value.trim();
    const phone = document.getElementById('suPhone').value.trim();
    const p1 = document.getElementById('suPass').value;
    const p2 = document.getElementById('suPass2').value;
    const msg = document.getElementById('signupMsg');

    // Client-side validation
    if (!firstName) {
      msg.textContent = 'First name is required';
      msg.className = 'msg error';
      return;
    }

    if (!lastName) {
      msg.textContent = 'Last name is required';
      msg.className = 'msg error';
      return;
    }

    if (!emailRx.test(email)) {
      msg.textContent = 'Please use your UNCC, Charlotte, or student email address';
      msg.className = 'msg error';
      return;
    }

    if (p1.length < 8) {
      msg.textContent = 'Password must be at least 8 characters long';
      msg.className = 'msg error';
      return;
    }

    if (p1 !== p2) {
      msg.textContent = 'Passwords do not match';
      msg.className = 'msg error';
      return;
    }

    try {
      msg.textContent = 'Creating account...';
      msg.className = 'msg';
      
      await API.signup(email, p1, firstName, lastName, phone || null);
      
      msg.textContent = 'Account created successfully! Redirecting...';
      msg.className = 'msg ok';
      setTimeout(() => window.location.href = 'marketplace.html', 1000);
      
    } catch (error) {
      console.error('Signup error:', error);
      msg.textContent = getErrorMessage(error);
      msg.className = 'msg error';
    }
  });

  // Login Form
  document.getElementById('loginForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const email = document.getElementById('liEmail').value.trim();
    const password = document.getElementById('liPass').value;
    const msg = document.getElementById('loginMsg');

    // Client-side validation
    if (!email) {
      msg.textContent = 'Email is required';
      msg.className = 'msg error';
      return;
    }

    if (!password) {
      msg.textContent = 'Password is required';
      msg.className = 'msg error';
      return;
    }

    try {
      msg.textContent = 'Logging in...';
      msg.className = 'msg';
      
      await API.login(email, password);
      
      msg.textContent = 'Login successful! Redirecting...';
      msg.className = 'msg ok';
      setTimeout(() => window.location.href = 'marketplace.html', 1000);
      
    } catch (error) {
      console.error('Login error:', error);
      msg.textContent = getErrorMessage(error);
      msg.className = 'msg error';
    }
  });

  // Redirect if already logged in
  if (API && API.isAuthenticated && API.isAuthenticated()) {
    window.location.href = 'marketplace.html';
  }
</script>
</body>
</html>