<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>GB&M – Home</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="styles/default.css">
  <link rel="stylesheet" href="styles/index.css">

</head>
<body>
<header>
  <div class="header-wrap">
    <a class="brand" href="index.html"><div class="logo">GB</div><div class="title">GitBooks & MORE</div></a>
    <div></div>
    <nav>
      <a href="marketplace.html">Marketplace</a>
      <a href="new-listing.html">Sell an Item</a>
      <a href="manage-listings.html">My Listings</a>
    </nav>
  </div>
</header>

<main class="wrap">
  <section class="panel">
    <h2 style="margin-top:0">Edit Listing</h2>
    <p id="sub" class="muted">Loading…</p>

    <label for="title">Title *</label>
    <input id="title" placeholder="e.g., Data Structures (4th ed.)" />

    <label for="cat" style="margin-top:8px">Category *</label>
    <select id="cat">
      <option value="">Select a category</option>
      <option>Textbooks</option>
      <option>Calculators</option>
      <option>Lab Kits</option>
      <option>Other</option>
    </select>

    <div class="row" style="margin-top:8px">
      <div>
        <label for="isbn">ISBN</label>
        <input id="isbn" placeholder="9780134685991" />
      </div>
      <div>
        <label for="course">Course #</label>
        <input id="course" placeholder="e.g., ITSC 3146" />
      </div>
    </div>

    <label for="price" style="margin-top:8px">Price ($) *</label>
    <input id="price" type="number" min="0" step="0.01" />

    <label for="desc" style="margin-top:8px">Description</label>
    <textarea id="desc" placeholder="Condition, professor, notes…"></textarea>

    <label for="file" style="margin-top:8px">Item Image</label>
    <input id="file" type="file" accept="image/*" />
    <div id="preview" class="preview">Image preview</div>

    <div class="row" style="margin-top:12px">
      <button id="save" class="btn">Save changes</button>
      <button id="cancel" class="btn btn-outline" type="button">Cancel</button>
    </div>
    <div id="msg" class="msg"></div>
  </section>
</main>

<script>

function qs(k){return new URLSearchParams(location.search).get(k)}
const id = Number(qs('id'));
const currentUserId = Number(localStorage.getItem('gbmo_currentUserId')||'42');
function getListings(){return JSON.parse(localStorage.getItem('gbmo_listings')||'[]')}
function setListings(v){localStorage.setItem('gbmo_listings',JSON.stringify(v))}

const sub = document.getElementById('sub');
const el = {
  title: document.getElementById('title'),
  cat: document.getElementById('cat'),
  isbn: document.getElementById('isbn'),
  course: document.getElementById('course'),
  price: document.getElementById('price'),
  desc: document.getElementById('desc'),
  file: document.getElementById('file'),
  preview: document.getElementById('preview'),
  msg: document.getElementById('msg'),
};

let listing = null;

function load(){
  const all = getListings();
  listing = all.find(x=>x.id===id);
  if(!listing){ sub.textContent='Listing not found.'; disableForm(true); return; }
  if(listing.ownerId!==currentUserId){ sub.textContent='Unauthorized to edit this listing.'; disableForm(true); return; }

  sub.textContent = `Editing #${id}`;
  el.title.value = listing.title || '';
  el.cat.value = listing.cat || '';
  el.isbn.value = listing.isbn || '';
  el.course.value = listing.course || '';
  el.price.value = listing.price ?? '';
  el.desc.value = listing.desc || '';
  if(listing.image){ showImage(listing.image); }
}
function disableForm(disabled){
  ['title','cat','isbn','course','price','desc','file','save'].forEach(k=>{
    const n = (k==='save')?document.getElementById('save'):el[k];
    if(n) n.disabled = disabled;
  });
}


function showImage(src){
  el.preview.innerHTML='';
  const img = new Image();
  img.src = src; img.style.width='100%'; img.style.height='100%'; img.style.objectFit='cover';
  el.preview.appendChild(img);
}
el.file.addEventListener('change',()=>{
  const f = el.file.files[0];
  if(!f){ el.preview.textContent='Image preview'; return; }
  const reader = new FileReader();
  reader.onload = e => showImage(e.target.result);
  reader.readAsDataURL(f);
});

document.getElementById('save').addEventListener('click', async ()=>{
  if(!listing) return;
  const title=el.title.value.trim(), cat=el.cat.value, price=parseFloat(el.price.value);
  if(!title || !cat || Number.isNaN(price)){
    el.msg.textContent='Title, Category, and Price are required.'; el.msg.className='msg error'; return;
  }

  listing.title=title; listing.cat=cat; listing.price=price;
  listing.isbn=el.isbn.value.trim(); listing.course=el.course.value.trim();
  listing.desc=el.desc.value.trim();

  if(el.file.files[0]){
    const dataUrl = await fileToDataUrl(el.file.files[0]);
    listing.image = dataUrl;
  }

  const all = getListings().map(x=>x.id===listing.id?listing:x);
  setListings(all);

  el.msg.textContent='Saved! Redirecting…'; el.msg.className='msg ok';
  setTimeout(()=>location.href='manage-listings.html',650);
});

document.getElementById('cancel').addEventListener('click',()=>history.back());

function fileToDataUrl(file){
  return new Promise(res=>{
    const reader = new FileReader();
    reader.onload = e => res(e.target.result);
    reader.readAsDataURL(file);
  });
}

load();
</script>
</body>
</html>
